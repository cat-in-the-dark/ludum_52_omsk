(()=>{"use strict";function t(t){return`${t.id}_${t.index}`}const s=new class{constructor(){this.pressedButtons=new Map}connect(){console.log("BUM"),this.pressedButtons.set("keyboard",new Set),window.addEventListener("keyup",(t=>{this.updateKeyboard(t.code,!1)})),window.addEventListener("keydown",(t=>{this.updateKeyboard(t.code,!0)})),window.addEventListener("gamepadconnected",(s=>{console.log("A gamepad connected:"),console.log(s.gamepad);const e=t(s.gamepad);this.pressedButtons.set(e,new Set)})),window.addEventListener("gamepaddisconnected",(s=>{console.log("A gamepad disconnected:"),console.log(s.gamepad);const e=t(s.gamepad);this.pressedButtons.delete(e)}))}updateKeyboard(t,s){s?this.pressedButtons.get("keyboard")?.add(t):this.pressedButtons.get("keyboard")?.delete(t)}isPressed(t,s="keyboard"){return this.pressedButtons.get(s)?.has(t)||!1}getPressed(){return this.pressedButtons}anyPressed(){for(const t of this.pressedButtons.values())if(t.size>0)return!0;return!1}updateGamepad(s){const e=new Map;e.set("X",s.buttons[2]?.pressed||!1),e.set("Y",s.buttons[3]?.pressed||!1),e.set("B",s.buttons[1]?.pressed||!1),e.set("A",s.buttons[0]?.pressed||!1),e.set("Fire",e.get("X")||e.get("Y")||e.get("B")||e.get("A")||!1),e.set("ArrowLeft",s.buttons[14]?.pressed||!1),e.set("ArrowRight",s.buttons[15]?.pressed||!1),e.set("ArrowUp",s.buttons[12]?.pressed||!1),e.set("ArrowDown",s.buttons[13]?.pressed||!1);const i=new Set;e.forEach(((t,s)=>{t&&i.add(s)}));const h=t(s);this.pressedButtons.set(h,i)}update(t){document.hasFocus()?navigator.getGamepads().forEach((t=>{t&&this.updateGamepad(t)})):this.pressedButtons.forEach((t=>{t.clear()}))}debug(){for(const[t,s]of this.pressedButtons)s.size>0&&console.log(t,s)}},e=new class{constructor(){this.current="",this.next="",this.scenes=new Map}get currentName(){return this.current}update(t){this.current!==this.next&&(console.log(`Transition from '${this.current}' to '${this.next}'`),this.scenes.get(this.current)?.exit(),this.current=this.next,this.scenes.get(this.current)?.activate());const s=this.scenes.get(this.current);s?s.update(t):console.error(`[SceneManager.update] unknown scene '${this.current}'`)}put(t,s){this.scenes.set(t,s)}set(t){this.next=t}};class i{constructor(t,s=0){this.time=t,this.elapsed=0,this.elapsed=s}get isPassed(){return this.elapsed>=this.time}get value(){return this.elapsed}get progress(){return this.elapsed/this.time}update(t){this.elapsed+=t}reset(t=0){this.elapsed=t}}function h(t,s,e){return Math.max(s,Math.min(e,t))}function r(t,s){return Math.random()*(s-t)+t}function a(t,s){return Array.from({length:s-t},((s,e)=>e+t))}function n(t,s,e){return t+(s-t)*e}function o(t,s){return t.minX<=s.maxX&&t.maxX>=s.minX&&t.minY<=s.maxY&&t.maxY>=s.minY}class c{constructor(t,s,e,i){this.x=t,this.y=s,this.w=e,this.h=i}get minX(){return this.x}get maxX(){return this.x+this.w}get minY(){return this.y}get maxY(){return this.y+this.h}}class d{constructor(t=0,s=0){this.x=t,this.y=s}add(t){return new d(t.x+this.x,t.y+this.y)}mul(t){return new d(this.x*t.x,this.y*t.y)}minus(t){return new d(this.x-t.x,this.y-t.y)}scale(t){return new d(this.x*t,this.y*t)}get sqrMagnitude(){return this.x*this.x+this.y*this.y}get magnitude(){return Math.sqrt(this.sqrMagnitude)}}class l{constructor(t,s){this.mapping=t,this.id=s}dir(){return s.isPressed(this.mapping.left,this.id)?[new d(-1,0),"LEFT"]:s.isPressed(this.mapping.right,this.id)?[new d(1,0),"RIGHT"]:s.isPressed(this.mapping.up,this.id)?[new d(0,-1),"UP"]:s.isPressed(this.mapping.down,this.id)?[new d(0,1),"DOWN"]:[new d(0,0),""]}dash(){return s.isPressed(this.mapping.dash,this.id)}update(t){}}class u{constructor(t,s,e=0,i=.1){this.ctx=t,this.pos=s,this.growValue=e,this.growSpeed=i,this.body=new c(4,4,24,24),this.time=0,this.grassinkas=a(0,12).map((()=>({pos:new d(r(-2,26),r(2,32)),color:`rgb(${r(30,70)}, ${r(120,220)}, 0)`,timeShift:r(0,1.5)})))}get isCollectable(){return this.growSpeed>0&&this.growValue>=.7}collect(){if(this.isCollectable){const t=this.growValue;return this.growSpeed=-5.5,t}return 0}get bodyRect(){return new c(this.pos.x+this.body.x,this.pos.y+this.body.y,this.body.w,this.body.h)}_drawGrassinka(t){this.ctx.save(),this.ctx.translate(t.pos.x,t.pos.y),this.ctx.strokeStyle=t.color,this.ctx.lineWidth=1+4*this.growValue;const s=t.timeShift+this.time,e={x:(2+5*Math.sin(2*s))*this.growValue,y:-16*this.growValue+0*Math.sin(3*s)};((t,s)=>{this.ctx.beginPath(),this.ctx.moveTo(4,0),this.ctx.quadraticCurveTo(1+3*this.growValue,-2-12*this.growValue,e.x,e.y),this.ctx.stroke()})(),this.ctx.restore()}update(t){this.time+=t,this.growValue=h(this.growValue+this.growSpeed*t,0,1),0===this.growValue&&(this.growSpeed=.1),this.ctx.save(),this.ctx.translate(this.pos.x,this.pos.y),this.ctx.fillStyle="darkgreen",this.ctx.fillRect(0,0,32,32),this.grassinkas.forEach((t=>this._drawGrassinka(t))),this.ctx.restore()}debugPhysics(){this.ctx.fillStyle="black",this.ctx.rect(this.bodyRect.x,this.bodyRect.y,this.bodyRect.w,this.bodyRect.h),this.ctx.stroke()}}class p{constructor(t){this.time=t,this.elapsed=0,this.isActive=!1,this.elapsed=t}invoke(){return!!this.isActive&&this.elapsed>=this.time&&(this.elapsed=0,!0)}update(t){this.elapsed+=t}start(){this.elapsed=0,this.isActive=!0}stop(){this.elapsed=0,this.isActive=!1}}class w{constructor(t){this.time=t,this.elapsed=0,this.elapsed=t}invoke(){return this.elapsed>=this.time&&(this.elapsed=0,!0)}update(t){this.elapsed+=t}reset(){this.elapsed=0}}function x(t){return 2.70158*t*t*t-1.70158*t*t}function g(t){const s=7.5625,e=2.75;return t<1/e?s*t*t:t<2/e?s*(t-=1.5/e)*t+.75:t<2.5/e?s*(t-=2.25/e)*t+.9375:s*(t-=2.625/e)*t+.984375}class m{constructor(t,s){this.time=t,this.func=s,this.elapsed=0,this.from=new d,this.target=new d,this.active=!1}get value(){if(this.elapsed>this.time)return this.target;const t=this.func(this.progress);return function(t,s,e){const i=n(t.x,s.x,e),h=n(t.y,s.y,e);return new d(i,h)}(this.from,this.target,t)}get progress(){return h(this.elapsed/this.time,0,1)}get isActive(){return this.active}update(t){this.active&&this.elapsed>this.time&&(this.active=!1),this.active&&(this.elapsed+=t)}start(t,s){this.elapsed=0,this.from=t,this.target=s,this.active=!0}}class y{constructor(t,s,e,h){this.ctx=t,this.pos=s,this.controls=e,this.texture=h,this.sizes=new d(48,48),this.speed=128,this.dirName="",this.dir=new d(0,0),this.dashDist=128,this.body=new c(4,4,this.sizes.x-8,this.sizes.y-8),this.dasher=null,this.dashedDist=32,this.dashedTween=new m(.4,g),this.blinker=new p(.05),this.stunTimer=new i(2,1e3),this.dashTween=new m(.5,x),this.dashCooldown=new w(2),this.collectedGrass=0}get bodyRect(){return new c(this.pos.x+this.body.x,this.pos.y+this.body.y,this.body.w,this.body.h)}collect(t){t.isCollectable&&!this.dashed&&(this.collectedGrass+=t.collect())}get dashing(){return this.dashTween.isActive}get dashed(){return this.dashedTween.isActive||null!==this.dasher||!this.stunTimer.isPassed}dashedBy(t){this.dashed||(this.dasher=t,this.blinker.start())}slideAfterDash(t){const s=t.scale(this.dashedDist),e=this.pos.add(s);this.dashedTween.start(this.pos,e)}update(t){if(this.dashTween.isActive)this.pos=this.dashTween.value;else if(this.dashedTween.isActive)this.pos=this.dashedTween.value;else if(this.dasher&&this.dasher.dashing){const t=this.dasher.dir.mul(this.dasher.sizes),h=(s=this.pos,e=this.dasher.pos.add(t),new d(0===(i=t).x?s.x:e.x,0===i.y?s.y:e.y));this.pos=h}else if(this.dasher&&!this.dasher.dashing)this.slideAfterDash(this.dasher.dir),this.stunTimer.reset(),this.dasher=null;else if(this.stunTimer.isPassed){const[s,e]=this.controls.dir();this.pos=this.pos.add(s.scale(t*this.speed)),s.sqrMagnitude>.01&&(this.dirName=e,this.dir=s),this.blinker.stop()}var s,e,i;if(!this.dashed&&this.controls.dash()&&this.dashCooldown.invoke()){const t=this.pos.add(this.dir.scale(this.dashDist));this.dashTween.start(this.pos,t)}this.pos=function(t,s,e){const i=e?.y||0,h=e?.x||0;return t.x<s.minX&&(t.x=s.minX),t.y<s.minY&&(t.y=s.minY),t.x>s.maxX-h&&(t.x=s.maxX-h),t.y>s.maxY-i&&(t.y=s.maxY-i),t}(this.pos,b,this.sizes),this.dashCooldown.update(t),this.dashTween.update(t),this.dashedTween.update(t),this.blinker.update(t),this.stunTimer.update(t),this.draw()}draw(){this.ctx.save(),this.ctx.translate(this.pos.x,this.pos.y),this.ctx.translate(this.sizes.x/2,this.sizes.x/2),this.flip(),this.ctx.translate(-this.sizes.x/2,-this.sizes.x/2),this.ctx.drawImage(this.texture,0,0),this.blinker.invoke()&&(this.ctx.fillStyle="red",this.ctx.fillRect(8,8,32,32)),this.ctx.restore()}debugPhysics(){this.ctx.fillStyle="black",this.ctx.rect(this.bodyRect.x,this.bodyRect.y,this.bodyRect.w,this.bodyRect.h),this.ctx.stroke()}flip(){switch(this.dirName){case"UP":default:break;case"DOWN":this.ctx.scale(1,-1);break;case"LEFT":this.ctx.rotate(-Math.PI/2);break;case"RIGHT":this.ctx.rotate(Math.PI/2)}}}class f{constructor(t,s){this.ctx=t,this.timer=s}update(t){const s=this.timer.value.toFixed(1);this.ctx.save(),this.ctx.translate(b.maxX+20,32),this.ctx.fillStyle="white",this.ctx.fillText(s.toString(),32,8),this.ctx.beginPath(),this.ctx.arc(0,0,16,0,2*Math.PI*this.timer.progress),this.ctx.fillStyle="white",this.ctx.fill(),this.ctx.strokeStyle="white",this.ctx.stroke(),this.ctx.restore()}}const b=new c(0,0,480,480);class v{constructor(t,s){this.ctx=t,this.tm=s,this.players=new Map,this.grass=[],this.levelTimer=new i(60,0),this.timerHud=new f(this.ctx,this.levelTimer),this.spawnPoses=[new d(b.minX+16,b.minY+16),new d(b.maxX-16-48,b.maxY-16-48),new d(b.minX+16,b.maxY-16-48),new d(b.maxX-16-48,b.minY+16)]}activate(){this.players=new Map,this.grass=a(0,15).flatMap((t=>a(0,15).map((s=>new u(this.ctx,new d(32*t,32*s),.8))))),this.levelTimer.reset(0)}update(t){this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.updateGrass(t),this.players.forEach((s=>s.update(t))),this.handleNewPlayer(),this.updatePhysics(),this.levelTimer.isPassed&&e.set("results"),this.players.size>0&&this.levelTimer.update(t),this.timerHud.update(t)}updateGrass(t){this.grass.forEach((s=>s.update(t)))}nextTrackTexture(){return this.tm.tractors[this.players.size]||this.tm.tractors[0]}trySpawn(t,s){"keyboard"===t&&!this.players.has("wasd")&&function(t){return t.has("KeyA")||t.has("KeyS")||t.has("KeyD")||t.has("KeyW")||t.has("KeyE")}(s)?(console.log("Spawn WASD"),this.players.set("wasd",new y(this.ctx,this.spawnPos(),new l({left:"KeyA",right:"KeyD",up:"KeyW",down:"KeyS",dash:"KeyE"},"keyboard"),this.nextTrackTexture()))):"keyboard"===t&&!this.players.has("arrows")&&function(t){return t.has("ArrowLeft")||t.has("ArrowRight")||t.has("ArrowUp")||t.has("ArrowDown")||t.has("ShiftRight")}(s)?(console.log("Spawn ARROWS"),this.players.set("arrows",new y(this.ctx,this.spawnPos(),new l({left:"ArrowLeft",right:"ArrowRight",up:"ArrowUp",down:"ArrowDown",dash:"ShiftRight"},"keyboard"),this.nextTrackTexture()))):"keyboard"===t||this.players.has(t)||(console.log("Spawn: ",t),this.players.set(t,new y(this.ctx,this.spawnPos(),function(t){return new l({left:"ArrowLeft",right:"ArrowRight",up:"ArrowUp",down:"ArrowDown",dash:"Fire"},t)}(t),this.nextTrackTexture())))}spawnPos(){return this.spawnPoses[this.players.size]||new d(16,16)}handleNewPlayer(){if(!(this.players.size>=4))for(const[t,e]of s.getPressed())0!==e.size&&this.trySpawn(t,e)}updatePhysics(){const t=[...this.players.values()];for(let s=0;s<t.length;s++){const e=t[s];if(e){for(let i=s+1;i<t.length;i++){const s=t[i];s&&(o(e.bodyRect,s.bodyRect)&&this.collidePlayers(e,s))}this.grass.forEach((t=>{o(t.bodyRect,e.bodyRect)&&e.collect(t)}))}}}collidePlayers(t,s){t.dashing&&!s.dashing&&s.dashedBy(t),!t.dashing&&s.dashing&&t.dashedBy(s)}exit(){}}class k{constructor(t,s){this.ctx=t,this.gameScreen=s}update(t){let s=0;this.ctx.save(),this.ctx.translate(b.maxX+8,64),this.ctx.fillStyle="white";for(const t of this.gameScreen.players.values()){const e=Math.round(t.collectedGrass);this.ctx.drawImage(t.texture,0,s*t.sizes.y),this.ctx.fillText(e.toString(),t.sizes.x+8,(s+.5)*t.sizes.y+12),s+=1}this.ctx.restore()}}class T{constructor(t,s){this.ctx=t,this.tm=s,this.timer=new i(2,0)}activate(){this.timer.reset()}update(t){this.ctx.save(),this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.fillStyle="white",this.ctx.fillText("POTRA4EHO",240,128),this.ctx.restore(),this.timer.isPassed&&s.anyPressed()&&e.set("game"),this.timer.update(t)}exit(){}}class S{constructor(t,s){this.ctx=t,this.tm=s,this.timer=new w(2)}activate(){this.timer.reset()}update(t){this.ctx.save(),this.ctx.drawImage(this.tm.logo,0,0),this.ctx.restore(),(s.anyPressed()||this.timer.invoke())&&e.set("game"),this.timer.update(t)}exit(){}}class A{constructor(t,s,i,h){this.ctx=t,this.hud=s,this.sm=i,this.tm=h;const r=new v(t,h);e.put("game",r),e.put("title",new S(t,h)),e.put("results",new T(t,h)),e.set("title"),this.scoreHud=new k(this.ctx,r)}update(t){e.update(t),s.isPressed("Escape")&&e.set("title"),"game"!==e.currentName&&"results"!==e.currentName||this.scoreHud.update(t)}}class P{constructor(t,s){this.node=t,this.context=s,this.offset=0,this.duration=this.node.buffer?.duration||0}start(){this.node.start(),this.offset=this.context.currentTime,console.log(this.context.outputLatency)}stop(){this.node.stop()}progress(){return(this.context.currentTime-this.offset)%this.duration}}class R{constructor(){this.context=new AudioContext,this.context.suspend(),this.tracks=new Map}resume(){this.context.resume()}async load(t){const s=t.map((t=>async function(t,s){console.log(`Loading ${s}`);const e=await async function(t,s){const e=await fetch(s),i=await e.arrayBuffer(),h=await t.decodeAudioData(i),r=new AudioBufferSourceNode(t,{buffer:h});return r.connect(t.destination),r}(t,s);return console.log(`Done loading ${s}`),new P(e,t)}(this.context,t))),e=await Promise.all(s);for(let s=0;s<t.length;s++){const i=t[s],h=e[s];i&&h&&this.tracks.set(i,h)}return e}}const M={},E={};async function B(t){return new Promise(((s,e)=>{const i=new Image;i.src=t,i.onload=()=>{s(i)},i.onerror=t=>{e(t)}}))}class z{constructor(t){this.ctx=t,this.time=0,this.counter=0,this.draw(60)}update(t){this.counter+=1,this.time+=t,this.time>1&&(this.draw(Math.floor(this.counter/this.time)),this.counter=0,this.time=0)}draw(t){this.ctx.save(),this.ctx.fillStyle="green",this.ctx.fillRect(520,449,120,30),this.ctx.fillStyle="white",this.ctx.fillText(`${t} FPS`,530,475),this.ctx.restore()}}function D(t){const s=document.getElementById(t);if(!s)throw new Error(`Canvas '${t}' not found`);const e=s.getContext("2d");if(!e)throw new Error("Cannot get mainContext");return e.font="24px font",e}var X;X=()=>{const t=document.querySelector("button"),e=document.getElementById("stage");e&&(t?.addEventListener("click",(()=>{e.style.display="block",t.disabled=!0,t.remove(),async function(){!async function(t,e){const i=await async function(){const t=new R;return await t.load(Object.values(M)),(await t.load(Object.values(E))).forEach((t=>t.node.loop=!0)),t.resume(),t}(),h=await async function(){return{logo:await B("logo_big.png"),tractors:[await B("tractor_01.png"),await B("tractor_02.png"),await B("tractor_03.png"),await B("tractor_04.png")]}}();s.connect();const r=new A(t,e,i,h);let a=-1;const n=new z(e);requestAnimationFrame((function t(e){a<0&&(a=e);const i=Math.min(1,(e-a)/1e3);a=e,r.update(i),s.update(i),n.update(i),requestAnimationFrame(t)}))}(D("ui-main"),D("ui-hud"))}()}),!1),console.log("WAITING"))},"loading"!==document.readyState?X():document.addEventListener("DOMContentLoaded",X)})();